<html>
    <head>
        <title>JSON PATCH TESTER</title>
        <meta charset='utf-8' />
        <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
        <link rel="stylesheet"
      href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/default.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js"></script>
    </head>
    <body>
        <h1>Documents</h1>
        <div id='app'>
            <span v-if="documentLoading">Loading…</span>
            <ul v-if="!documentLoading">
                <li v-for="document in documents">
                    {{ document }}
                    <button v-on:click="selectDocument(document)">open</button>
                    <button v-on:click="deleteDocument(document)">delete</button>
                </li>
                <li v-if="!documentLoading && documents.length === 0">
                    Documents not found.
                </li>
                <li>
                    <input v-model:strip="newName" />
                    <button
                        :disabled="newName.length == 0"
                        v-on:click="createEmptyDocument(newName)"
                    > create </button>
                </li>
            </ul>
            <button v-on:click="refreshList()">Refresh list</button>
            <div v-if="selectedName">
                <hr />
                <h1>{{ selectedName }}</h1>
                <span v-if="selectedLoading">Loading…</span>
                <pre><code class="html" v-html="selectedDocument"></code></pre>
                <table>
                    <tr>
                        <th>OP</th>
                        <th>FROM</th>
                        <th>PATH</th>
                        <th>VALUE</th>
                        <th>*</th>
                    </tr>
                    <tr v-for="cmd, index in commands">
                        <td>
                            <select v-model="cmd.op">
                                <option>add</option>
                                <option>remove</option>
                                <option>replace</option>
                                <option>copy</option>
                                <option>move</option>
                                <option>test</option>
                            </select>
                        </td>
                        <td v-if="['move', 'copy'].indexOf(cmd.op) > -1">
                            <input v-model:strip="cmd.from" placeholder="from" />
                        </td>
                        <td v-else>-</td>
                        <td>
                            <input v-model:strip="cmd.path" placeholder="path" />
                        </td>
                        <td v-if="['remove', 'copy', 'move'].indexOf(cmd.op) == -1">
                            <input v-model:strip="cmd.value" placeholder="value" />
                        </td>
                        <td v-else>-</td>
                        <td>
                            <button v-on:click="deleteCommand(index)">REMOVE</button>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="4"></td>
                        <td><button v-on:click="addCommand()">ADD</button></td>
                    </tr>
                </table>
                <button v-on:click="patchDocument()">Update document</button>
            </div>
        </div>
        <script>
function fetchJson(endpoint, options) {
    return fetch(endpoint, options).then(function (resp) {
        if (resp.status !== 200){
            throw new Error("wrong status: " + resp.status);
        }
        return resp.json();
    });
}

function created() {
    this.refreshList();
}

function refreshList() {
    var self = this;
    self.documents = [];
    self.documentLoading = true;
    fetchJson("/documents/").then(function (body) {
        self.documents = body;
        self.documentLoading = false;
    });
}

function selectDocument(filename) {
    var self = this;
    self.selectedLoading = true;
    self.selectedName = filename;
    self.selectedDocument = null;
    fetchJson("/documents/" + filename)
        .then(fillSelectedDocument.bind(this));
}

function fillSelectedDocument(jsonBody) {
    var rawBody = JSON.stringify(jsonBody, null, '    ');
    var hljsObj = hljs.highlight('javascript', rawBody);
    this.selectedDocument = hljsObj.value;
    this.selectedLoading = false;
    this.commands = [];
}

function deleteDocument(filename) {
    var self = this;
    self.documentLoading = true;
    fetch("/documents/" + filename, {method: "DELETE"}).then(function (resp) {
        self.documents = self.documents.filter(function (doc) {
            return doc !== filename;
        });
        self.documentLoading = false;
        if (self.selectedName == filename) {
            self.selectedName = null;
            self.selectedDocument = null;
            self.commands = [];
        }
    });
}

function createEmptyDocument(name) {
    var self = this;
    var dotIndex = name.indexOf('.');
    name = dotIndex > -1? name.substr(0, dotIndex) : name;
    var filename = name + ".json";
    self.newName = "";
    self.selectedName = filename;
    self.selectedLoading = true;
    self.documentLoading = true;
    var options = {method: "PUT", body: "{}"}
    fetchJson("/documents/" + filename, options).then(function (body) {
        self.documents.push(filename);
        self.documentLoading = false;
        self.fillSelectedDocument(body);
    });
}

function addCommand() {
    this.commands.push({
        op: "replace",
        path: "",
        value: "",
        from: ""
    });
}

function deleteCommand(index) {
    this.commands = this.commands.filter(function (_, i) { return i !== index; });
}

function patchDocument() {
    var commands = prepareCommandsToSend(this.commands);
    if (commands === null) {
        return;
    }
    this.selectedLoading = true;
    var options = {method: 'PATCH', body: JSON.stringify(commands)};
    fetchJson("/documents/" + this.selectedName, options)
        .then(this.fillSelectedDocument.bind(this));
}

function prepareCommandsToSend(commands) {
    commands = JSON.parse(JSON.stringify(commands)); // deepcopy lol
    var hasErrors = false;
    commands.forEach(function (cmd, index) {
        if (['move', 'copy'].indexOf(cmd.op) == -1) {
            delete cmd.from;
        }
        if (['remove', 'copy', 'move'].indexOf(cmd.op) > -1) {
            delete cmd.value;
        } else {
            try {
                cmd.value = JSON.parse(cmd.value);
            } catch(err) {
                alert("ERROR! in " + (index + 1) + " command value:\n" + err);
                hasErrors = true;
            };
        }
    });
    return hasErrors? null : commands;

}

var data = {
    documents: [],
    documentLoading: false,
    newName: "",
    selectedName: null,
    selectedDocument: null,
    selectedLoading: false,
    commands: []
}

var app = new Vue({
    el: '#app',
    data: data,
    created: created,
    methods: {
        selectDocument: selectDocument,
        deleteDocument: deleteDocument,
        createEmptyDocument: createEmptyDocument,
        fillSelectedDocument: fillSelectedDocument,
        refreshList: refreshList,
        addCommand: addCommand,
        deleteCommand: deleteCommand,
        patchDocument: patchDocument
    }
});
        </script>
    </body>
</html>
