<html>
    <head>
        <title>JSON PATCH TESTER</title>
        <meta charset='utf-8' />
        <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
        <link rel="stylesheet"
      href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/default.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js"></script>
    </head>
    <body>
        <h1>Documents</h1>
        <div id='app'>
            <span v-if="documentLoading">Loading…</span>
            <ul v-if="!documentLoading">
                <li v-for="document in documents">
                    {{ document }}
                    <button v-on:click="selectDocument(document)">open</button>
                    <button v-on:click="deleteDocument(document)">delete</button>
                </li>
                <li v-if="!documentLoading && documents.length === 0">
                    Documents not found.
                </li>
                <li>
                    <input v-model:strip="newName" />
                    <button
                        :disabled="newName.length == 0"
                        v-on:click="createEmptyDocument(newName)"
                    > create </button>
                </li>
            </ul>
            <button v-on:click="refreshList()">Refresh list</button>
            <div v-if="selectedName">
                <h2>{{ selectedName }}</h2>
                <span v-if="selectedLoading">Loading…</span>
                <pre><code class="html" v-html="selectedDocument"></code></pre>
            </div>
        </div>
        <script>
function fetchJson(endpoint, options) {
    return fetch(endpoint, options).then(function (resp) { return resp.json(); });
}

function created() {
    this.refreshList();
}

function refreshList() {
    var self = this;
    self.documents = [];
    self.documentLoading = true;
    fetchJson("/documents/").then(function (body) {
        self.documents = body;
        self.documentLoading = false;
    });
}

function selectDocument(filename) {
    var self = this;
    self.selectedLoading = true;
    self.selectedName = filename;
    self.selectedDocument = null;
    fetchJson("/documents/" + filename)
        .then(fillSelectedDocument.bind(this));
}

function fillSelectedDocument(jsonBody) {
    var rawBody = JSON.stringify(jsonBody, null, ' ');
    var hljsObj = hljs.highlight('javascript', rawBody);
    this.selectedDocument = hljsObj.value;
    this.selectedLoading = false;
}

function deleteDocument(filename) {
    var self = this;
    self.documentLoading = true;
    fetch("/documents/" + filename, {method: "DELETE"}).then(function (resp) {
        self.documents = self.documents.filter(function (doc) {
            return doc !== filename;
        });
        self.documentLoading = false;
    });
}

function createEmptyDocument(name) {
    var self = this;
    var dotIndex = name.indexOf('.');
    name = dotIndex > -1? name.substr(0, dotIndex) : name;
    var filename = name + ".json";
    self.newName = "";
    self.selectedName = filename;
    self.selectedLoading = true;
    self.documentLoading = true;
    var options = {method: "PUT", body: "{}"}
    fetchJson("/documents/" + filename, options).then(function (body) {
        self.documents.push(filename);
        self.documentLoading = false;
        self.fillSelectedDocument(body);
    });
}

var data = {
    documents: [],
    documentLoading: false,
    selectedName: null,
    newName: "",
    selectedDocument: null,
    selectedLoading: false
}

var app = new Vue({
    el: '#app',
    data: data,
    created: created,
    methods: {
        selectDocument: selectDocument,
        deleteDocument: deleteDocument,
        createEmptyDocument: createEmptyDocument,
        fillSelectedDocument: fillSelectedDocument,
        refreshList: refreshList
    }
});
        </script>
    </body>
</html>
